---
layout:     post
title:      一堆垃圾 sql 的备份
subtitle:   sql
date:       2019-06-12
author:     TGich
header-img: img/post-bg-cook.jpg
catalog: true
tags:
    - sql
---

## 每月对账单

### 出库明细

``` sql
# 出库明细
select psod.bar_code 条码,
psod.goods_name 商品名称,
pb.name 品牌名称,
psod.goods_color 商品规格,
psod.specs_name 商品尺码,
pg.goods_price 商品原价,
pg.goods_code 商品编号,
psod.send_num 商品数量,
pg.member_price 会员价,
ifnull(pg.category_name, '') 品类,
ifnull(pg.thin_thick, '') 薄厚,
ifnull(pg.long_short, '') 长短,
ifnull(pg.suit_people, '') 适应人群,
ifnull(pg.suit_season, '') 适应季节,
ifnull(pg.accessory, '') 配饰,
ifnull(pg.style_no, '') 款号,
pg.buy_price 采购价,
pg.collection_premium 手续费,
pg.postage 运费,
psoo.send_store_name 出库门店,
psoo.received_store_name 入库门店,
psod.order_id 出库单号,
psoo.send_time 出库时间,
case psoo.status when 'S' then '已入库' when 'AW' then '待审核' when 'W' then '待入库' end 出库单状态
from p_stock_order_details psod
left join p_goods pg on pg.goods_id = psod.goods_id
left join p_brand pb on pb.id = pg.brand_id
left join p_stock_out_order psoo on psoo.id = psod.order_id
where 1 = 1
and psoo.send_time between '2019-05-01 00:00:00' and '2019-05-31 23:59:59'
and psod.order_type = 1
and (psoo.status = 'W' or psoo.status = 'AW' or psoo.status = 'S');
```

### 线上退货对账单

``` sql
# 线上退货对账单
select pro.update_time '退货时间',
pro.id '退货单号',
concat("\t", pro.order_id) '原订单号',
case po.trade_type when 'JSAPI' then '小程序' when 'APP' then 'APP' end '下单渠道',
case po.pay_channel when 'wxpay' then '微信' when 'alipay' then '支付宝' when 'balancepay' then '余额' end '支付渠道',
po.create_time '订单时间',
po.contacts '联系人',
po.mobile_phone '手机号',
pod.goods_name '商品名称',
pb.name '品牌',
pg.style_no '款号',
pg.goods_color '颜色',
pod.specs_name '尺码',
pod.bar_code '商品条码',
pg.goods_price '商品原价',
pg.member_price '会员价',
pod.goods_price '现价',
pg.buy_price '采购价',
prfo.refund_price '退款金额'
from p_return_order pro
left join p_order po on po.id = pro.order_id
left join p_refund_order prfo on prfo.return_order_id = pro.id
left join p_order_details pod on pod.id = pro.order_detail_id
left join p_goods pg on pg.goods_id = pod.goods_id
left join p_brand pb on pb.id = pg.brand_id
where 1 = 1
and pro.update_time between '2019-05-01 00:00:00' and '2019-05-31 23:59:59'
and pro.status = 'RS'
and pro.whole_or_single = 2;
```

### 快递对账

``` sql
# 快递对账
select
concat("\t", pp.transaction_id) 微信流水号,
po.activity_id 活动ID,
concat("\t", po.id) 订单ID,
pol.logistics_name 快递公司,
concat("\t", pol.logistics_no) 快递单号,
po.remark 备注,
po.contacts 联系人,
po.mobile_phone 电话,
(select pa.shortname
from p_area pa
where pa.id = pua.province) 省,
(select pa.shortname
from p_area pa
where pa.id = pua.city) 市,
(select pa.shortname
from p_area pa
where pa.id = pua.area) 区县,
po.detailed_address 详细地址,
pg.category_name 品类,
pg.suit_people 适用人群,
pod.goods_name 商品名称,
pg.goods_code 商品编码,
pg.goods_color 商品颜色,
pgs.specs_name 尺码,
pod.goods_num 数量,
po.price 订单支付,
po.create_time 下单时间
from p_order po
left join p_order_logistics pol on pol.order_id = po.id
left join p_order_details pod on pod.order_id = po.id
left join p_goods pg on pg.goods_id = pod.goods_id
left join p_goods_stock pgs on pgs.goods_id = pod.goods_id and pgs.specs_name = pod.specs_name
left join p_user_address pua on pua.id = po.user_address_id
left join p_pay pp on pp.order_id = po.id
where 1 = 1
and po.logistic_status != 'LW'
and (po.is_offline = 0 or po.is_offline is null)
and (po.order_type = 2 or po.order_type is null)
and (po.pay_type = 1 or po.pay_type is null)
and po.create_time between '2018-07-01 00:00:00' and '2018-12-31 23:59:59'
order by po.create_time desc;
```

### 爱库存订单发货状态

``` sql
# 爱库存订单发货状态
select concat("\t", po.id) 系统订单ID,
concat("\t", psod.supplier_ext_order_id) 爱库存订单ID,
po.contacts 联系人,
po.mobile_phone 手机,
po.detailed_address 地址,
po.remark 备注,
pb.name 品牌,
pod.goods_name 商品,
pg.goods_color 颜色,
pod.specs_name 尺码,
pgs.bar_code 条码,
po.create_time 下单时间,
case po.order_status
when 'S'
then '支付成功'
when 'AU'
then '退款审核中'
when 'RS'
then '退款成功'
when 'C'
then '已完成' end 系统订单状态,
case
po.logistic_status
when 'LU'
then '已发货'
when 'LP'
then '部分发货'
when 'LS'
then '已收货'
when 'LW'
then '待发货' end 发货状态,
pg.category_name 品类,
concat("\t", pg.goods_code) 商品编码,
psa.name 爱库存活动名称,
psa.start_date 爱库存活动开始时间,
psa.end_date 爱库存活动结束时间,
psg.settlement_price 爱库存结算金额,
pod.goods_price 销售价,
po.coupon_price 订单优惠金额,
pod.goods_num 数量,
case psod.status
when 1
then '用户已申请取消'
when 0
then '正常购买'
when 2
then '平台同意'
else psod.status end 爱库存明细状态,
case psod.product_status
when 0
then '未捞单'
when 1
then '已捞单或处理中'
when 2
then '已发货'
when 4
then '用户取消不发货'
when 11
then '系统取消不发货'
else psod.product_status end 爱库存商品状态,
case psod.after_sale_status
when 0
then '未申请售后'
when 1
then '用户申请售后'
when 11
then '待退货'
else psod.after_sale_status end 爱库存售后状态
from p_order po
left join p_supplier_order pso on pso.order_id = po.id
left join p_order_details pod on pod.order_id = po.id
left join p_goods pg on pg.goods_id = pod.goods_id
left join p_brand pb on pb.id = pg.brand_id
left join p_goods_stock pgs on pgs.goods_id = pod.goods_id and pgs.specs_name = pod.specs_name
left join p_supplier_activity psa on psa.id = pg.live_id
left join p_supplier_goods psg on psg.product_id = pg.product_id
left join p_supplier_order_detail psod on psod.order_detail_id = pod.id
where 1 = 1
and pg.supplier_no = 'aikucun'
and (po.order_status = 'S' or po.order_status = 'C' or po.order_status = 'RS' or po.order_status = 'AU')
and po.create_time between '2019-04-01 00:00:00' and '2019-04-30 23:59:59'
order by po.create_time desc;
```

## 其他导出

### 导出商品库存

``` sql
# 商品库存
select pgc.store_name 门店名,
pgc.brand_name 品牌,
pgc.goods_name 商品名,
pg.arrival_date 到货日期,
pgc.goods_num 库存,
pg.goods_price 原价,
pg.member_price 会员价,
pg.buy_price 成本价,
pg.collection_premium 手续费,
pg.supplier 供应商,
concat("\t", pgc.bar_code) 条码,
pgc.goods_color 颜色,
pgc.specs_name 尺码,
concat("\t", pgc.goods_code) 商品编码,
ifnull(pg.suit_season, '无') 适用季节,
ifnull(pgc.suit_people, '无') 适用人群,
ifnull(pgc.category_name, '无') 类别,
ifnull(pg.thin_thick, '无') 薄厚款,
ifnull(pg.long_short, '无') 长短款,
ifnull(pg.accessory, '无') 配饰
from p_goods_cache pgc
left join p_goods pg on pg.goods_id = pgc.goods_id
where pgc.goods_num > 0;
```

## 其他查询

### 线下店有码商品入库与售出差异

``` sql
# 线下店有码商品入库与售出差异
select
a.goods_name 商品名称,
a.goods_id 商品ID,
a.specs_name 规格,
a.bar_code 条码,
a.name 品牌,
a.num 售出数量,
b.num 入库数量
from
(
SELECT
pod.goods_name,
pod.goods_id,
pod.specs_name,
pb.name,
pss.bar_code,
sum(pod.goods_num) num
FROM p_order_details pod
LEFT JOIN p_order po ON po.id = pod.order_id
LEFT JOIN p_store_stock pss ON pss.goods_id = pod.goods_id
AND pss.specs_name = pod.specs_name
AND pss.store_no = po.store_no
left join p_goods pg on pg.goods_id = pod.goods_id
left join p_brand pb on pb.id = pg.brand_id
WHERE 1 = 1
AND po.store_no = 'S00000007'
AND (po.order_status = 'S'
OR po.order_status = 'C'
OR po.order_status = 'AU')
AND po.pay_type = 2
GROUP BY pod.goods_name,
pod.goods_id,
pod.specs_name,
pss.bar_code) a,
(
SELECT
psod.goods_name,
psod.goods_id,
psod.specs_name,
psod.bar_code,
psod.brand_name,
sum(psod.received_num) num
FROM p_stock_order_details psod
LEFT JOIN p_stock_in_order psio ON psio.id = psod.order_id
WHERE 1 = 1
AND psio.received_store_no = 'S00000007'
AND (psod.order_type = 2 or psod.order_type is null)
GROUP BY psod.goods_name,
psod.goods_id,
psod.specs_name,
psod.bar_code,
psod.brand_name
) b
where 1 = 1
and b.goods_id = a.goods_id
and b.specs_name = a.specs_name
and b.num < a.num;
```

### 对比入库数和现有库存数

``` sql
# 对比入库数和现有库存数
select
pss.bar_code,
pss.goods_id,
pss.specs_name,
pss.goods_qty,
psod.goods_id,
psod.specs_name,
psod.bar_code,
psod.received_num
from p_store_stock pss
left join p_stock_in_order psio on psio.received_store_no = pss.store_no
left join p_stock_order_details psod
on psod.bar_code = pss.bar_code and psod.order_id = psio.id and psod.order_type = 2
where 1 = 1
and pss.store_no = 'S00000007';
```

### 库存查重

``` sql
# 库存查重
select *
from p_store_stock
where 1 = 1
  and goods_qty > 0
group by bar_code
having count(bar_code) > 1;
```

### 售出条码查重

``` sql
# 售出条码查重
select *
from p_order_details
where bar_code in
      (select bar_code
       from p_order_details pod
                left join p_order po on pod.order_id = po.id
                left join p_goods pg on pg.goods_id = pod.goods_id
                left join p_brand pb on pb.id = pg.brand_id
       where 1 = 1
         and bar_code != ''
#                      and pb.id = 936
         and (po.order_status = 'S' or po.order_status = 'C')
       group by bar_code
       having count(bar_code) > 1);
```

### 出库条码查重

``` sql
# 出库条码查重
select *
from p_store_stock
where bar_code in
      (select psod.bar_code
       from p_stock_order_details psod
                left join p_stock_out_order psoo on psoo.id = psod.order_id
                left join p_goods pg on pg.goods_id = psod.goods_id
                left join p_brand pb on pb.id = pg.brand_id
                left join p_store ps on ps.store_no = psoo.send_store_no
       where 1 = 1
         and psod.order_type = 1
         and psoo.send_store_no = 'S00000001'
#          and pb.id = 936
       group by bar_code
       having count(bar_code) > 1);
```

### 查询无详情出库单

``` sql
# 查询无详情出库单
select *
from p_stock_out_order psoo
         left join (
    select count(1) qty, order_id
    from p_stock_order_details
    where order_type = 1
    group by order_id
) a on a.order_id = psoo.id
where 1 = 1
  and qty is null
  and status != 'Q'
  and status != 'AF';
```

### 补录无详情出库单

``` sql
# 补录无详情出库单
insert into p_stock_order_details (order_type, order_id, goods_name, send_num, goods_id, specs_name,
                                   bar_code, goods_color, brand_id, brand_name, scan_times)
select 1,
       2733,
       goods_name,
       1,
       goods_id,
       specs_name,
       bar_code,
       goods_color,
       brand_id,
       name,
       1
from p_stock_out_temp_bak psotb
         left join p_brand pb on pb.id = psotb.brand_id
where stock_out_order_id = 2733;
```

### 查询已出库条码存在于最后一次出库门店的库存大于0的记录

``` sql
# 查询已出库条码存在于最后一次出库门店的库存大于0的记录
select max(psod.id) id,
       psod.bar_code,
       psod.goods_name,
       psod.brand_name,
       psoo.id,
       psoo.send_store_no,
       psoo.send_store_name,
       psoo.create_time,
       psoo.status
from p_stock_order_details psod
         left join p_stock_out_order psoo on psoo.id = psod.order_id and psod.order_type = 1
         left join p_store_stock pss on pss.store_no = psoo.send_store_no
where 1 = 1
  and (psoo.status = 'W' or psoo.status = 'AW' or psoo.status = 'S')
  and pss.goods_qty > 0
group by psod.bar_code, psod.id
order by id desc;
```

### 查询中央仓出过库且现库存为1且未存在入库记录的条码（概念同上一条）

``` sql
# 查询中央仓出过库且现库存为1且未存在入库记录的条码
select *
from p_store_stock pss
         left join p_goods pg on pg.goods_id = pss.goods_id
         left join p_stock_order_details psod on psod.bar_code = pss.bar_code and psod.order_type = 1
         left join p_stock_out_order psoo on psoo.id = psod.order_id
where 1 = 1
  and pss.goods_qty = 1
  and pss.store_no = 'S00000001'
  and pg.supplier_no is null
  and pss.bar_code is not null
  and psoo.send_store_no = 'S00000001'
  and (psoo.status = 'W' or psoo.status = 'AW' or psoo.status = 'S')
  and psoo.create_time between '2019-03-01 00:00:00' and '2019-06-30 00:00:00'
  and psod.order_type = 1
  and psod.bar_code not in (
    select psod2.bar_code
    from p_stock_order_details psod2
             left join p_stock_in_order psio on psio.id = psod2.order_id and psod2.order_type = 2
    where 1 = 1
      and pss.bar_code = psod2.bar_code
);
```

### 查询中央仓出过库且现库存为1且未存在入库记录的条码v2（概念同上一条）

``` sql
# 查询中央仓出过库且现库存为1且未存在入库记录的条码v2（概念同上一条）
select *
from p_store_stock pss
where 1 = 1
  and goods_qty > 0
  and store_no = 'S00000001'
  and pss.bar_code in (
    select psod1.bar_code
    from p_stock_order_details psod1
             left join p_stock_out_order psoo1 on psoo1.id = psod1.order_id and psod1.order_type = 1
    where 1 = 1
      and (psoo1.status = 'W' or psoo1.status = 'AW' or psoo1.status = 'S')
      and psoo1.send_store_no = 'S00000001'
      and psod1.order_type = 1
)
  and pss.bar_code not in (
    select psod2.bar_code
    from p_stock_order_details psod2
             left join p_stock_in_order psoo2 on psoo2.id = psod2.order_id and psod2.order_type = 2
    where 1 = 1
      and psod2.order_type = 2
)
  and pss.bar_code not in (
    select p_stock_order_feedback.bar_code
    from p_stock_order_feedback
);
```

### 添加商品到出库车

``` sql
# 添加商品到出库车
insert into p_stock_out_temp (user_name, send_store_no, received_store_no, goods_id, specs_name, goods_name, goods_num,
                              add_time, bar_code, goods_color, brand_id, is_codeless, scan_times)
select '中央仓',
       'S00000001',
       'S00000013',
       pss.goods_id,
       pss.specs_name,
       pg.goods_name,
       1,
       now(),
       pss.bar_code,
       pg.goods_color,
       pg.brand_id,
       0,
       1
from p_store_stock pss
         left join p_goods pg on pg.goods_id = pss.goods_id
where 1 = 1
  and pss.store_no = 'S00000001'
  and pss.bar_code in (
                       'DHY92205271077',
                       'DHY92205271357',
                       'DHY92205271279'
    );
```

### 导出9.9会费统计

``` sql
# 导出9.9会费统计
select
       ps.store_name,
       po.wx_uid,
       wu.nick_name,
       wu.verify_phone,
       pod.goods_name,
       pod.original_price,
       pod.goods_price,
       po.create_time,
       po.id,
       pp.id,
       po.trade_type,
       po.pay_type,
       po.logistic_status,
       po.is_offline,
       po.coupon_price,
       po.paid_amount,
       po.order_type,
       po.pay_channel,
pocr.nick_name
from p_order_details pod
left join p_order po on po.id=pod.order_id
left join p_store ps on ps.store_no=po.store_no
left join wx_user wu on wu.wx_uid=po.wx_uid
left join p_pay pp on pp.order_id=po.id
left join p_order_confirm_record pocr on pocr.order_id=po.id
where 1=1
and( po.order_status='C' or po.order_status='S')
and pod.goods_id=10
order by create_time desc
```
